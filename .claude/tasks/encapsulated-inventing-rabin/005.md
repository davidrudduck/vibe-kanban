---
name: Add model change detection to follow_up handler
status: complete
created: 2026-01-23T08:40:46Z
updated: 2026-01-23T11:02:00Z
depends_on: [004]
parallel: false
conflicts_with: []
---

# Task: Add model change detection to follow_up handler

## Description
Modify the follow_up route handler to detect when the model has changed between sessions. When a model change is detected, start a fresh session (no session_id) to avoid context incompatibility.

## Acceptance Criteria
- [x] Model change detection logic added after executor_profile_id construction
- [x] Previous and current models compared using CodingAgent.model()
- [x] model_changed boolean flag computed
- [x] Tracing log added when model changes
- [x] Session ID logic updated to respect model_changed flag

## Technical Details

**File Location**: `crates/server/src/routes/task_attempts/handlers/follow_up.rs`

**Add After Line 113** (after `let skip_context = ...`):
```rust
// Check if model changed (would cause context loss)
let model_changed = {
    let previous_agent = executor_configs.get_coding_agent_or_default(&initial_executor_profile_id);
    let current_agent = coding_agent;
    let previous_model = previous_agent.model();
    let current_model = current_agent.model();
    previous_model != current_model
};

if model_changed {
    tracing::info!(
        task_attempt_id = %task_attempt.id,
        previous_variant = ?initial_executor_profile_id.variant,
        current_variant = ?executor_profile_id.variant,
        "Model changed between sessions, starting fresh to avoid context incompatibility"
    );
}
```

**Update Session ID Logic** (lines 219-229):
```rust
// Determine session ID to use:
// 1. If skip_context is enabled, start fresh (None)
// 2. If model changed, start fresh (None) to avoid context incompatibility
// 3. If we have a pre_retry_session_id from before dropping, use it
// 4. Otherwise, find the latest session ID from remaining processes
let latest_session_id = if skip_context || model_changed {
    None
} else if let Some(session_id) = pre_retry_session_id {
    Some(session_id)
} else {
    ExecutionProcess::find_latest_session_id_by_task_attempt(
        &deployment.db().pool,
        task_attempt.id,
    )
    .await?
};
```

**Key Changes**:
- Add `|| model_changed` to the session_id conditional
- Log when model changes are detected
- Preserve all existing logic for other cases

## Dependencies
- Task 004: CodingAgent.model() method must exist

## Effort Estimate
- Size: S
- Hours: 0.75
- Parallel: false

## Definition of Done
- [x] Model change detection code added
- [x] Comparison uses CodingAgent.model() correctly
- [x] Tracing log added with structured fields
- [x] Session ID logic updated with model_changed check
- [x] Code compiles without errors
- [x] Clippy passes (pre-existing executors crate errors unrelated to changes)
- [x] Existing tests still pass
- [x] Logic preserves backward compatibility
