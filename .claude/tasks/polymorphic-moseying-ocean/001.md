---
name: Fix Injected Messages Filter in useConversationHistory
status: complete
created: 2026-01-19T05:21:32Z
updated: 2026-01-19T15:56:00Z
depends_on: []
conflicts_with: []
---

# Task: Fix Injected Messages Filter in useConversationHistory

## Description
Modify the filter logic in `useConversationHistory.ts` to preserve injected user messages. The current filter removes ALL `user_message` entries, which inadvertently removes injected messages that should be displayed in the conversation UI.

## Acceptance Criteria
- [x] Injected messages appear in the conversation log with "Injected" label
- [x] Original prompt still appears at the start of the conversation
- [x] Non-injected user messages are still filtered out (replaced by original prompt)
- [x] Injected messages persist after page refresh
- [x] No TypeScript compilation errors

## Technical Details

### Implementation Approach
Add a condition to the filter at lines 400-405 in `useConversationHistory.ts` to check for `metadata?.injected === true` before excluding user_message entries.

### Code Change

**File**: `frontend/src/hooks/useConversationHistory.ts` lines 400-405

**Before:**
```typescript
// Remove all coding agent added user messages, replace with our custom one
const entriesExcludingUser = p.entries.filter(
  (e) =>
    e.type !== 'NORMALIZED_ENTRY' ||
    e.content.entry_type.type !== 'user_message'
);
```

**After:**
```typescript
// Remove non-injected user messages from coding agent, replace with our custom one
// Keep injected messages (they have metadata.injected === true)
const entriesExcludingUser = p.entries.filter(
  (e) =>
    e.type !== 'NORMALIZED_ENTRY' ||
    e.content.entry_type.type !== 'user_message' ||
    e.content.metadata?.injected === true
);
```

### Key Considerations
- The `UserMessage.tsx` component already handles displaying the "Injected" label when `metadata?.injected === true` (line 30)
- No backend changes needed - the data is already persisted correctly
- The `metadata` field type should be checked in `shared/types.ts` to ensure safe access

## Dependencies
- [x] None - this is a standalone frontend change

## Effort Estimate
- Size: XS
- Hours: 0.5

## Definition of Done
- [x] Code implemented (single line change)
- [x] TypeScript compilation succeeds (`npx tsc --noEmit`)
- [x] ESLint passes (`npm run lint`)
- [x] Manual testing confirms injected messages appear
- [x] Manual testing confirms original prompt still appears
- [x] Manual testing confirms persistence after refresh
