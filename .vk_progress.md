# Swarm Implementation - Remote Task Attempt Operations

## Current Status: **in-progress**

## Overview
Implementing remote task attempt operations for the swarm/hive setup. Steps 1-4 complete.

## Completed Items

### Step 1: RemoteTaskAttemptContext ✓
- [x] Added `RemoteTaskAttemptContext` struct to `crates/server/src/middleware/model_loaders.rs`
- [x] Added `is_available()` and `node_url()` helper methods matching `RemoteProjectContext` pattern

### Step 2: Modified load_task_attempt_impl ✓
- [x] Enhanced middleware to load parent Task and Project
- [x] Injects `RemoteTaskAttemptContext` when project is remote
- [x] Uses `shared_task_id` for cross-node routing

### Step 2.5: check_remote_task_attempt_proxy helper ✓
- [x] Added helper function in `crates/server/src/routes/task_attempts.rs`
- [x] Returns `(node_url, node_id, task_id)` tuple when remote and online
- [x] Returns `ApiError::BadGateway` when node offline or no URL
- [x] Added 4 unit tests for the helper

### Step 3: By-Task-ID Routes ✓
- [x] Added `load_task_attempt_by_task_id_middleware` to model_loaders.rs
- [x] Added `load_task_attempt_by_task_id_middleware_with_wildcard` variant
- [x] Middleware validates proxy token when connection token validator is enabled
- [x] Finds task by `shared_task_id`, loads most recent attempt
- [x] Registered by-task-id routes in task_attempts.rs router

### Step 4: Add Proxy Logic to Handlers ✓
Added proxy support to 15 handlers in `task_attempts.rs`:
- [x] `follow_up` - POST proxy
- [x] `stop_task_attempt_execution` - POST proxy
- [x] `get_task_attempt_branch_status` - GET proxy
- [x] `merge_task_attempt` - POST proxy
- [x] `push_task_attempt_branch` - POST proxy
- [x] `force_push_task_attempt_branch` - POST proxy
- [x] `rebase_task_attempt` - POST proxy
- [x] `create_github_pr` - POST proxy
- [x] `change_target_branch` - POST proxy
- [x] `rename_branch` - POST proxy
- [x] `abort_conflicts_task_attempt` - POST proxy
- [x] `attach_existing_pr` - POST proxy
- [x] `list_worktree_files` - GET proxy
- [x] `read_worktree_file` - GET proxy

Also added `Serialize` to request structs and `Deserialize` to response structs as needed for proxy operations.

## Remaining Work
- [ ] Step 5: Add remote attempt start (backend + frontend)
- [ ] Step 6: Add remote diff streaming (frontend)
- [ ] Step 7: Add connection status badge (frontend)

## Files Modified
| File | Changes |
|------|---------|
| `crates/server/src/middleware/model_loaders.rs` | Added `RemoteTaskAttemptContext`, enhanced `load_task_attempt_impl`, added by-task-id middleware |
| `crates/server/src/routes/task_attempts.rs` | Added `check_remote_task_attempt_proxy` helper, unit tests, by-task-id routes, and proxy logic to 15 handlers |

## Build Status
- [x] `npm run check` passing
- [x] Unit tests passing (9 tests)
- [x] No compiler warnings (helper function now used)

## Next Session Recommendations
1. **Step 5**: Add remote attempt start
   - Backend: Add endpoint to list nodes where project exists
   - Backend: Modify create_task_attempt to proxy to target node
   - Frontend: Add node selector UI when multiple nodes available
2. **Step 6**: Add remote diff streaming (frontend)
3. **Step 7**: Add connection status badge (frontend)

## Architecture Notes
The implementation follows the established pattern from remote projects:
- `RemoteProjectContext` (model_loaders.rs) → `RemoteTaskAttemptContext`
- `check_remote_proxy` (projects.rs) → `check_remote_task_attempt_proxy`
- `load_project_by_remote_id_middleware` → `load_task_attempt_by_task_id_middleware`
- Middleware loads Task + Project to determine if remote context needed
- Proxy logic uses `node_proxy_client().proxy_get()`/`proxy_post()` with by-task-id routes
