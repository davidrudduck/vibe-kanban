# WebSocket Issues Fix - Progress

## Current Status: **needs-review**

## Summary
Fixed intermittent WebSocket issues causing:
- "WebSocket is closed before the connection is established" errors
- Task status not updating after follow-up prompts
- Conversation not refreshing without page reload
- Task staying in "in review" instead of moving to "in progress"

## Completed Items

### P1 Fixes (Critical)
- [x] Memoized endpoint in `useDiffStream.ts` - prevents unnecessary reconnections
- [x] Added AbortController in `useJsonPatchWsStream.ts` - cancels pending connections on cleanup
- [x] Added active heartbeat reconnection (60s idle timeout)

### P2 Fixes (Important)
- [x] Extended `TaskOptimisticContext` for status updates
- [x] Added `updateTaskStatusOptimistically` to `useProjectTasks`
- [x] Updated `useFollowUpSend` to call optimistic status update
- [x] Updated `TaskFollowUpSection` to pass taskId/projectId
- [x] Updated `ProjectTasks.tsx` to use new optimistic context

### P3 Fixes (Nice to have)
- [x] Reviewed backend broadcast - already has 5s timeout, frontend optimistic approach preferred

## Files Modified
1. `frontend/src/hooks/useDiffStream.ts` - Memoized endpoint
2. `frontend/src/hooks/useJsonPatchWsStream.ts` - AbortController + heartbeat
3. `frontend/src/contexts/TaskOptimisticContext.tsx` - Status update registry
4. `frontend/src/hooks/useProjectTasks.ts` - updateTaskStatusOptimistically
5. `frontend/src/hooks/follow-up/useFollowUpSend.ts` - Optimistic status update
6. `frontend/src/components/tasks/TaskFollowUpSection.tsx` - Pass taskId/projectId
7. `frontend/src/pages/ProjectTasks.tsx` - Use new context prop

## Testing Required
Browser testing needed for:
1. Create new task - verify appears on kanban without refresh
2. Send follow-up prompt - verify task moves to "in progress" immediately
3. Navigate rapidly between tasks - check for "closed before established" errors
4. Wait 60+ seconds idle - verify reconnection works

## Build Status
- [x] TypeScript check passing (`npm run check`)
- [x] Backend check passing (`cargo check`)
- [x] No lint errors

## Next Session Recommendations
1. Run the dev server and test in browser across different scenarios
2. Monitor browser console for WebSocket errors during rapid navigation
3. Test the optimistic update flow end-to-end
