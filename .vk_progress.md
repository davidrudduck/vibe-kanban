# Unified Project View with Sorting - Progress Tracker

## Status: in-progress

## Overview
Merge local and remote projects into a single unified view with sorting options, and remove the Active Tasks banner.

## Completed Items

### Session 1: Backend - MergedProject Endpoint ✅
- [x] Added `MergedProject` struct with `#[derive(TS)]` in `crates/server/src/routes/projects.rs`
  - Includes: `id`, `name`, `git_repo_path`, `created_at`, `remote_project_id`, `has_local`, `local_project_id`, `nodes`, `last_attempt_at`
- [x] Added `NodeLocation` struct with `#[derive(TS)]`
  - Includes: `node_id`, `node_name`, `node_short_name`, `node_status`, `node_public_url`, `remote_project_id`
- [x] Added `MergedProjectsResponse` wrapper struct
- [x] Added `find_local_projects_with_last_attempt()` query in `crates/db/src/models/project.rs`
  - Uses LEFT JOIN to task_attempts to get MAX(updated_at) as last_attempt_at
  - Returns `Vec<(Project, Option<DateTime<Utc>>)>`
- [x] Created `get_merged_projects()` route handler with merging logic:
  - Fetches local projects with last attempt timestamps
  - Fetches remote projects from cached_projects
  - Fetches node information from cached_nodes
  - Groups linked projects by remote_project_id
  - Creates MergedProject entries with correct location info
  - Adds `truncate_node_name()` helper (e.g., "tardis.raverx.net" → "tardis")
- [x] Registered route: `GET /api/merged-projects`
- [x] Updated `crates/server/src/bin/generate_types.rs` with new type declarations
- [x] Updated SQLx offline cache (`npm run prepare-db`)
- [x] Ran `npm run generate-types` to create TypeScript types in `shared/types.ts`
- [x] Tested endpoint with curl - returns correct merged project structure

### Session 2: Frontend - UnifiedProjectCard Component ✅
- [x] Created `UnifiedProjectCard.tsx` with props for `MergedProject`
  - Accepts `project: MergedProject`, `isFocused`, `onRefresh`, `onEdit` props
- [x] Implemented card layout: name, linked badge, menu, date, location badges
  - Card displays project name, created date with calendar icon
  - "Linked" badge shown when `remote_project_id` is set (with dark mode support)
  - Dropdown menu with context-sensitive actions
- [x] Implemented location badge logic
  - Shows "local" badge when `has_local` is true
  - Shows node short names for remote locations
  - Map pin icon with gray styling
- [x] Implemented conditional actions menu based on `has_local`
  - Local projects: View, Open in IDE, Link to Remote, Edit Settings, Delete
  - Remote-only projects: View, Link to Local Folder
- [x] Created `useMergedProjects.ts` hook for fetching merged projects
- [x] Added `getMerged()` method to `projectsApi` in `lib/api.ts`
- [x] Added `linkToLocalFolder` translation key to all locales (en, ja, ko, es)
- [x] Added temporary test section in `ProjectList.tsx` for Session 2 verification
- [x] Tested in browser with Playwright:
  - Verified rendering at desktop (1280x720), tablet (768x1024), mobile (375x667) viewports
  - Verified dropdown menu actions for local projects
  - Verified light and dark mode styling

### Session 3: Frontend - ProjectSortControls & ProjectList Update ✅
- [x] Created `ProjectSortControls.tsx` dropdown component
  - Four sort options: A→Z, Z→A, Recent Activity, Oldest Activity
  - Icons for each option (ArrowDownAZ, ArrowUpZA, Clock, History)
  - Uses shadcn/ui Select component
- [x] Added localStorage persistence for sort option
  - Key: `project-sort-option`
  - Default: `name_asc`
  - `loadSortOption()` and `saveSortOption()` helper functions
- [x] Added i18n translation keys for sorting in all locales (en, ja, ko, es)
  - `sort.label`, `sort.nameAsc`, `sort.nameDesc`, `sort.recentActivity`, `sort.oldestActivity`
  - Added `sections.allProjects` key
- [x] Updated `ProjectList.tsx`:
  - Removed `StatusSummaryBanner` component and import
  - Removed separate local/remote project sections
  - Now fetches from `/api/merged-projects` using `useMergedProjects` hook
  - Added sorting controls next to "All Projects (N)" header
  - Uses `UnifiedProjectCard` for all projects
  - Implemented client-side sorting logic for all 4 options
  - Projects with no `last_attempt_at` sort to bottom for activity-based sorts
- [x] Tested in browser with Playwright:
  - Verified at desktop (1280x720), tablet (768x1024), mobile (375x667) viewports
  - Verified sort dropdown opens and shows all 4 options
  - Verified localStorage persistence - sort option persists after page refresh
  - Verified light and dark mode styling - all text readable
  - No console errors, no TypeScript errors

## Files Modified in Session 3

| File | Change |
|------|--------|
| `frontend/src/components/projects/ProjectSortControls.tsx` | Created new sort controls component with localStorage persistence |
| `frontend/src/components/projects/ProjectList.tsx` | Replaced separate sections with unified view, added sorting |
| `frontend/src/i18n/locales/en/projects.json` | Added sort and allProjects translation keys |
| `frontend/src/i18n/locales/ja/projects.json` | Added sort and allProjects translation keys |
| `frontend/src/i18n/locales/ko/projects.json` | Added sort and allProjects translation keys |
| `frontend/src/i18n/locales/es/projects.json` | Added sort and allProjects translation keys |

## Remaining Work

### Session 4: Frontend - "Link to Local Folder" Action
- [ ] Add dialog/form for entering local folder path
- [ ] Create backend endpoint to create local project and link to remote
- [ ] Add mutation in `useProjectMutations.ts`
- [ ] Wire up the action in `UnifiedProjectCard`

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/merged-projects` | Get unified list of local and remote projects |

## API Response Example
```json
{
  "success": true,
  "data": {
    "projects": [
      {
        "id": "c8809147-3066-439e-9f2b-9477cb3e8bec",
        "name": "vibe-kanban",
        "git_repo_path": "/home/david/Code/vibe-kanban",
        "created_at": "2025-11-28T03:41:40.239Z",
        "remote_project_id": null,
        "has_local": true,
        "local_project_id": "c8809147-3066-439e-9f2b-9477cb3e8bec",
        "nodes": [],
        "last_attempt_at": "2025-12-17T06:03:03Z"
      }
    ]
  }
}
```

## Next Session Recommendations

Session 4 should implement the "Link to Local Folder" action:
1. Create a dialog component for entering/browsing local folder path
2. Create backend endpoint `POST /api/projects/link-local` that:
   - Creates a new local project at the specified path
   - Links it to the specified remote project via `remote_project_id`
3. Add mutation in `useProjectMutations.ts` or create new hook
4. Wire up the action in `UnifiedProjectCard` for remote-only projects
5. Test the full flow in browser
