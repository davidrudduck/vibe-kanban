# Task Variables Feature - Implementation Progress

## Status: in-progress

## Overview
Adding a variable system to vibe-kanban that allows users to define key-value pairs at the task level, which are automatically expanded in task descriptions when sent to executors. Child tasks inherit variables from parent tasks.

## Plan File
`/home/david/.claude/plans/plucky-honking-church.md`

---

## Session 1: Variable Expander with Tests (TDD)

### Completed Items
- [x] Created `variable_expander.rs` with comprehensive TDD tests
- [x] Implemented `expand_variables()` function supporting `$VAR` and `${VAR}` syntax
- [x] Added `ExpansionResult` struct with text, undefined_vars, and expanded_vars fields
- [x] Implemented helper functions: `is_var_start()`, `is_var_char()`, `parse_braced_var()`, `parse_simple_var()`
- [x] Added module to `services/mod.rs`
- [x] All 29 tests passing
- [x] Clippy: No warnings
- [x] Formatting: Correctly formatted

### Files Changed
| File | Change |
|------|--------|
| `crates/services/src/services/variable_expander.rs` | NEW - Variable expansion logic with 29 tests |
| `crates/services/src/services/mod.rs` | Added `pub mod variable_expander;` |

### Test Results
```text
running 29 tests
test services::variable_expander::tests::test_adjacent_variables ... ok
test services::variable_expander::tests::test_braced_var_adjacent_chars ... ok
test services::variable_expander::tests::test_braced_var_expansion ... ok
test services::variable_expander::tests::test_dollar_at_end ... ok
test services::variable_expander::tests::test_dollar_followed_by_space ... ok
test services::variable_expander::tests::test_duplicate_undefined_variable ... ok
test services::variable_expander::tests::test_empty_braces ... ok
test services::variable_expander::tests::test_empty_input ... ok
test services::variable_expander::tests::test_empty_value ... ok
test services::variable_expander::tests::test_long_variable_name ... ok
test services::variable_expander::tests::test_lowercase_not_variable ... ok
test services::variable_expander::tests::test_mixed_syntax ... ok
test services::variable_expander::tests::test_multiline_text ... ok
test services::variable_expander::tests::test_no_variables ... ok
test services::variable_expander::tests::test_number_start_not_variable ... ok
test services::variable_expander::tests::test_practical_plan_file ... ok
test services::variable_expander::tests::test_simple_var_expansion ... ok
test services::variable_expander::tests::test_source_tracking ... ok
test services::variable_expander::tests::test_special_chars_in_value ... ok
test services::variable_expander::tests::test_unclosed_brace ... ok
test services::variable_expander::tests::test_undefined_braced_variable ... ok
test services::variable_expander::tests::test_undefined_variable ... ok
test services::variable_expander::tests::test_unicode_text ... ok
test services::variable_expander::tests::test_value_with_dollar_sign ... ok
test services::variable_expander::tests::test_value_with_var_pattern ... ok
test services::variable_expander::tests::test_var_at_boundaries ... ok
test services::variable_expander::tests::test_var_with_underscores_and_numbers ... ok
test services::variable_expander::tests::test_whitespace ... ok
test services::variable_expander::tests::test_braced_lowercase_start ... ok

test result: ok. 29 passed; 0 failed; 0 ignored; 0 measured; 106 filtered out
```

### Validation
- `cargo test -p services variable_expander`: 29/29 tests passed
- `cargo clippy -p services -- -D warnings`: No warnings
- `cargo fmt -p services -- --check`: OK

---

## Session 2: Database Migration + TaskVariable Model (COMPLETED)

### Note
Session 2 work was already completed in origin/main before this session started. This session verified and validated the existing implementation.

### Completed Items
- [x] Database migration created: `20251222080043_add_task_variables.sql`
- [x] TaskVariable model with all structs (`TaskVariable`, `CreateTaskVariable`, `UpdateTaskVariable`, `ResolvedVariable`)
- [x] CRUD operations: `find_by_task_id`, `find_by_id`, `create`, `update`, `delete`
- [x] TypeScript generation with `#[derive(TS)]`
- [x] Types exported in `shared/types.ts`
- [x] Inheritance resolution with `find_inherited()` using recursive CTE (O(1) query)
- [x] REST API routes implemented
- [x] 8 inheritance integration tests passing
- [x] All validation checks passing

### Files Present
| File | Description |
|------|-------------|
| `crates/db/migrations/20251222080043_add_task_variables.sql` | Migration creating `task_variables` table |
| `crates/db/src/models/task_variable.rs` | TaskVariable model with CRUD + inheritance |
| `crates/db/src/models/mod.rs` | Module exports `task_variable` |
| `crates/db/tests/task_variable_inheritance.rs` | 8 integration tests for inheritance |
| `crates/server/src/routes/task_variables.rs` | REST API endpoints |
| `shared/types.ts` | TypeScript types generated |

### Database Schema
```sql
CREATE TABLE task_variables (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    name TEXT NOT NULL CHECK(name GLOB '[A-Z][A-Z0-9_]*'),
    value TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now', 'subsec')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now', 'subsec')),
    UNIQUE(task_id, name)
);

CREATE INDEX idx_task_variables_task_id ON task_variables(task_id);
```

### API Endpoints
- `GET /api/tasks/:id/variables` - list own variables
- `GET /api/tasks/:id/variables/resolved` - list with inheritance
- `POST /api/tasks/:id/variables` - create (validates name format)
- `PUT /api/tasks/:id/variables/:var_id` - update
- `DELETE /api/tasks/:id/variables/:var_id` - delete
- `POST /api/tasks/:id/variables/preview` - preview expansion

### Test Results
```text
running 8 tests
test test_find_inherited_child_overrides_parent ... ok
test test_find_inherited_deep_hierarchy ... ok
test test_find_inherited_empty_no_variables ... ok
test test_find_inherited_inherits_from_ancestors ... ok
test test_find_inherited_no_parent_returns_own_vars ... ok
test test_find_inherited_results_sorted_by_name ... ok
test test_find_inherited_partial_override_in_chain ... ok
test test_find_inherited_parent_only_variables ... ok

test result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

### Validation
- `cargo test -p db --test task_variable_inheritance`: 8/8 tests passed
- `cargo clippy -p db -- -D warnings`: No warnings
- `npm run check`: All checks passing

---

## Feature Details

### Variable Expansion
- **Syntax**: Supports `$VAR` and `${VAR}` (braced for adjacent characters)
- **Variable Names**: Must match `[A-Z][A-Z0-9_]*` (uppercase, start with letter)
- **Undefined Variables**: Left unexpanded and tracked in `undefined_vars`
- **Source Tracking**: Tracks which task each variable came from via `expanded_vars`

### ExpansionResult Structure
```rust
pub struct ExpansionResult {
    pub text: String,                              // Expanded text
    pub undefined_vars: Vec<String>,               // Variables that were not defined
    pub expanded_vars: Vec<(String, Option<Uuid>)>, // Variables that were expanded (name, source_task_id)
}
```

### ResolvedVariable Structure
```rust
pub struct ResolvedVariable {
    pub name: String,
    pub value: String,
    pub source_task_id: Uuid,  // Task ID where variable was defined
    pub inherited: bool,        // True if from parent task
}
```

---

## Remaining Steps (Future Sessions)
- Session 5: Executor integration
- Session 6: MCP Server tools
- Session 7: Frontend API + hooks
- Session 8: VariableEditor component
- Session 9: Task form integration
- Session 10: Variables panel
