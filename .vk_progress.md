# MCP HTTP Server Implementation

## Status: needs-review

## Overview
Implementation of HTTP transport for the MCP server to allow executors to connect to a locally running MCP server rather than the published npm package.

## Session 1: Add HTTP Transport to MCP Binary

### Completed Items
- [x] Updated `crates/server/Cargo.toml` with required features:
  - Added `transport-streamable-http-server` feature
  - Added `transport-worker` feature (required by streamable-http-server in rmcp 0.5.0)
- [x] Updated `crates/server/src/bin/mcp_task_server.rs`:
  - Added CLI argument parsing for `--http` and `--port`
  - Extracted `get_base_url()` as separate async fn
  - Added `run_stdio_server()` for existing stdio mode
  - Added `run_http_server()` using `StreamableHttpService`
  - Main routes to appropriate mode based on args

### Test Results

#### Test 1: Build compiles without errors ✅
```bash
cargo build --bin mcp_task_server
# Finished `dev` profile [unoptimized + debuginfo]
```

#### Test 2: HTTP server starts ✅
```bash
VIBE_BACKEND_URL=http://127.0.0.1:5002 ./target/debug/mcp_task_server --http --port 5010
# [MCP] Starting HTTP server at http://0.0.0.0:5010/mcp
# [MCP] HTTP server listening at http://0.0.0.0:5010/mcp
```

#### Test 3: MCP protocol responds correctly ✅
```bash
curl -X POST http://127.0.0.1:5010/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -d '{"jsonrpc":"2.0","id":1,"method":"initialize",...}'

# HTTP/1.1 200 OK
# content-type: text/event-stream
# mcp-session-id: ab7c6fdd-3abb-4233-957d-81f6e68b80b1
# data: {"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05",...}}
```

#### Test 4: Stdio mode still works ✅
```bash
echo '{"jsonrpc":"2.0","id":1,"method":"initialize",...}' | \
  VIBE_BACKEND_URL=http://127.0.0.1:5002 ./target/debug/mcp_task_server
# {"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05",...}}
```

#### Test 5: Clippy passes ✅
```bash
cargo clippy --bin mcp_task_server -- -D warnings
# Finished `dev` profile - no warnings
```

---

## Session 2: Backend Auto-Spawns MCP Server

### Completed Items
- [x] Added `spawn_mcp_http_server()` function to `crates/server/src/main.rs`
  - Reads `MCP_PORT` environment variable
  - Finds `mcp_task_server` binary in same directory as server
  - Spawns child process with `--http --port` args
  - Sets `VIBE_BACKEND_URL` for child process
  - Returns `Option<Child>` for cleanup
- [x] Integrated spawn call after `actual_port` is known
- [x] Added graceful child process termination on shutdown
  - Calls `kill()` on child process
  - Waits for child to fully exit with `wait()`

### Test Results

#### Test 1: Without MCP_PORT - no spawn ✅
```bash
timeout 5 ./target/debug/server 2>&1 | grep -i mcp
# (no output - MCP not spawned)
```

#### Test 2: With MCP_PORT - spawns and logs ✅
```bash
MCP_PORT=5065 BACKEND_PORT=5060 ./target/debug/server
# [2025-12-24T02:25:17Z] INFO server: Server running on http://0.0.0.0:5060
# [2025-12-24T02:25:17Z] INFO server: [MCP] Spawning HTTP server at http://0.0.0.0:5065/mcp
# [2025-12-24T02:25:17Z] INFO server: [MCP] HTTP server started (PID: 796433)
# [2025-12-24T02:25:17Z] INFO mcp_task_server: [MCP] Starting HTTP server at http://0.0.0.0:5065/mcp
# [2025-12-24T02:25:17Z] INFO mcp_task_server: [MCP] HTTP server listening at http://0.0.0.0:5065/mcp
```

#### Test 3: MCP responds while backend is running ✅
```bash
curl -s -X POST http://127.0.0.1:5065/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -d '{"jsonrpc":"2.0","id":1,"method":"initialize",...}'

# data: {"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"vibe-kanban","version":"1.0.0"},...}}
```

#### Test 4: Child process terminates on shutdown ✅
```bash
# After sending SIGTERM to server:
# ✓ MCP process terminated successfully
# ✓ Server process terminated successfully
```

#### Test 5: Clippy passes ✅
```bash
cargo clippy --bin server -- -D warnings
# Finished `dev` profile - no warnings
```

---

## Session 3: Documentation & Cleanup

### Completed Items
- [x] Documented `MCP_PORT` in `CLAUDE.md` Environment Variables section
- [x] Ran `cargo clippy --all --all-targets --all-features -- -D warnings` - passes
- [x] End-to-end test with `pnpm run dev`:
  - Backend started on port 5070
  - MCP HTTP server auto-spawned on port 5080
  - Frontend started on port 5071
  - MCP responds correctly to initialize request
  - Application fully functional in browser
  - Tested light and dark mode - no contrast issues
  - Tested mobile viewport (375x812) - works correctly

### Test Results

#### Test 1: MCP_PORT documented in CLAUDE.md ✅
Added to Environment Variables section:
```markdown
MCP Server:
- `MCP_PORT`: Port for HTTP MCP server. If set, backend auto-spawns MCP HTTP server at `http://{HOST}:{MCP_PORT}/mcp`. This allows executors to connect to a locally running MCP server instead of the published npm package.
```

#### Test 2: Cargo clippy passes ✅
```bash
cargo clippy --all --all-targets --all-features -- -D warnings
# Finished `dev` profile - no warnings
```

#### Test 3: End-to-end with pnpm run dev ✅
```bash
MCP_PORT=5080 BACKEND_PORT=5070 FRONTEND_PORT=5071 pnpm run dev
# Backend: http://0.0.0.0:5070
# Frontend: http://localhost:5071
# MCP HTTP: http://0.0.0.0:5080/mcp

# MCP initialize test:
curl -s -X POST http://127.0.0.1:5080/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{...}}'
# Returns: {"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05",...}}
```

## Files Changed

| File | Change |
|------|--------|
| `crates/server/Cargo.toml` | Added `transport-streamable-http-server` and `transport-worker` features to rmcp |
| `crates/server/src/bin/mcp_task_server.rs` | Complete rewrite with HTTP mode support |
| `crates/server/src/main.rs` | Added `spawn_mcp_http_server()` function and integration |
| `CLAUDE.md` | Documented `MCP_PORT` environment variable |

## Implementation Complete

All 3 sessions have been completed. The feature is ready for PR review.

### How to Use

1. Set `MCP_PORT` environment variable to enable the MCP HTTP server:
   ```bash
   MCP_PORT=8081 pnpm run dev
   ```

2. The backend will auto-spawn the MCP HTTP server at `http://{HOST}:{MCP_PORT}/mcp`

3. Configure your executor (Claude Code, etc.) to connect to the local MCP server instead of `npx vibe-kanban@latest`
