# Swarm Implementation - Remote Task Attempt Operations

## Current Status: **in-progress**

## Overview
Implementing remote task attempt operations for the swarm/hive setup. Steps 1-3 complete.

## Completed Items

### Step 1: RemoteTaskAttemptContext ✓
- [x] Added `RemoteTaskAttemptContext` struct to `crates/server/src/middleware/model_loaders.rs`
- [x] Added `is_available()` and `node_url()` helper methods matching `RemoteProjectContext` pattern

### Step 2: Modified load_task_attempt_impl ✓
- [x] Enhanced middleware to load parent Task and Project
- [x] Injects `RemoteTaskAttemptContext` when project is remote
- [x] Uses `shared_task_id` for cross-node routing

### Step 2.5: check_remote_task_attempt_proxy helper ✓
- [x] Added helper function in `crates/server/src/routes/task_attempts.rs`
- [x] Returns `(node_url, node_id, task_id)` tuple when remote and online
- [x] Returns `ApiError::BadGateway` when node offline or no URL
- [x] Added 4 unit tests for the helper

### Step 3: By-Task-ID Routes ✓
- [x] Added `load_task_attempt_by_task_id_middleware` to model_loaders.rs
- [x] Added `load_task_attempt_by_task_id_middleware_with_wildcard` variant
- [x] Middleware validates proxy token when connection token validator is enabled
- [x] Finds task by `shared_task_id`, loads most recent attempt
- [x] Registered by-task-id routes in task_attempts.rs router:
  - `/api/task-attempts/by-task-id/{task_id}/follow-up`
  - `/api/task-attempts/by-task-id/{task_id}/stop`
  - `/api/task-attempts/by-task-id/{task_id}/branch-status`
  - `/api/task-attempts/by-task-id/{task_id}/push`
  - `/api/task-attempts/by-task-id/{task_id}/push/force`
  - `/api/task-attempts/by-task-id/{task_id}/merge`
  - `/api/task-attempts/by-task-id/{task_id}/rebase`
  - `/api/task-attempts/by-task-id/{task_id}/conflicts/abort`
  - `/api/task-attempts/by-task-id/{task_id}/change-target-branch`
  - `/api/task-attempts/by-task-id/{task_id}/rename-branch`
  - `/api/task-attempts/by-task-id/{task_id}/pr`
  - `/api/task-attempts/by-task-id/{task_id}/pr/attach`
  - `/api/task-attempts/by-task-id/{task_id}/draft` (GET/PUT/DELETE)
  - `/api/task-attempts/by-task-id/{task_id}/draft/queue`
  - `/api/task-attempts/by-task-id/{task_id}/files`
  - `/api/task-attempts/by-task-id/{task_id}/files/{*file_path}`
  - `/api/task-attempts/by-task-id/{task_id}/diff/ws`

## Remaining Work
- [ ] Step 4: Add proxy logic to core handlers
- [ ] Step 5: Add remote attempt start (backend + frontend)
- [ ] Step 6: Add remote diff streaming (frontend)
- [ ] Step 7: Add connection status badge (frontend)

## Files Modified
| File | Changes |
|------|---------|
| `crates/server/src/middleware/model_loaders.rs` | Added `RemoteTaskAttemptContext`, enhanced `load_task_attempt_impl`, added by-task-id middleware |
| `crates/server/src/routes/task_attempts.rs` | Added `check_remote_task_attempt_proxy` helper, unit tests, and by-task-id routes |

## Build Status
- [x] `npm run check` passing
- [x] Backend compiles with warning about unused function (expected until Step 4)
- [x] Unit tests passing (9 tests)

## Next Session Recommendations
1. **Step 4**: Add proxy logic to handlers starting with:
   - `follow_up`
   - `stop_task_attempt_execution`
   - `get_task_attempt_branch_status`
2. Continue with git, PR, file, and draft operations
3. Frontend work (Steps 5-7)

## Architecture Notes
The implementation follows the established pattern from remote projects:
- `RemoteProjectContext` (model_loaders.rs) → `RemoteTaskAttemptContext`
- `check_remote_proxy` (projects.rs) → `check_remote_task_attempt_proxy`
- `load_project_by_remote_id_middleware` → `load_task_attempt_by_task_id_middleware`
- Middleware loads Task + Project to determine if remote context needed
